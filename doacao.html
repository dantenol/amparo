<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doação | AMPARO</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="./sendForm.js"></script>
    <link rel="stylesheet" href="./perguntas.css" />
    <link rel="stylesheet" href="./main.css" />
  </head>

  <body>
    <div id="container" class="fullscreen">
      <div class="question">
        <p class="title">Preencha os dados para receber sua doação!</p>
        <button class="next">Começar</button>
      </div>
      <div class="question">
        <p class="title">Seu nome e sobrenome<span>*</span></p>
        <input
          type="text"
          name="entry.1707728601"
          id="1707728601"
          placeholder="Digite aqui..."
          data-required="true"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">CPF<span>*</span></p>
        <p class="subtitle">Será mantido em sigilo</p>
        <input
          type="text"
          name="entry.859324267"
          id="859324267"
          placeholder="Digite aqui..."
          data-required="true"
          data-mask="000.000.000-00"
          data-regex="^\d{3}.\d{3}.\d{3}-\d{2}$"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Celular<span>*</span></p>
        <p class="subtitle">Com WhatsApp</p>
        <input
          type="tel"
          name="entry.472405798"
          id="472405798"
          placeholder="Digite aqui..."
          data-required="true"
          data-mask="(00) 00000-0000"
          data-regex="^\(\d{2}\) \d{5}-\d{4}$"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Profissão</p>
        <input
          type="text"
          name="entry.1851459686"
          id="1851459686"
          placeholder="Digite aqui..."
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Cidade<span>*</span></p>
        <input
          type="text"
          name="entry.1509069398"
          id="1509069398"
          placeholder="Digite aqui..."
          data-required="true"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Bairro<span>*</span></p>
        <input
          type="text"
          name="entry.1231759706"
          id="1231759706"
          placeholder="Digite aqui..."
          data-required="true"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Rua<span>*</span></p>
        <input
          type="text"
          name="entry.106456020"
          id="106456020"
          placeholder="Digite aqui..."
          data-required="true"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Número e complemento<span>*</span></p>
        <input
          type="text"
          name="entry.505288745"
          id="505288745"
          placeholder="Digite aqui..."
          data-required="true"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Ponto de referência</p>
        <p class="subtitle">Como podemos identificar sua casa?</p>
        <input
          type="text"
          name="entry.805271285"
          id="805271285"
          placeholder="Digite aqui..."
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Quantas pessoas moram na casa?<span>*</span></p>
        <p class="subtitle">Incluindo você</p>
        <input
          type="number"
          name="entry.1238987351"
          id="1238987351"
          placeholder="Digite aqui..."
          data-required="true"
        /><button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Fonte de renda</p>
        <p class="subtitle">Será mantida em sigilo</p>
        <div class="multipleChoiceContainer">
          <input
            type="checkbox"
            value="Salário"
            name="entry.730457284"
            id="730457284.Salário"
          />
          <label for="730457284.Salário">Salário</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Auxílio_emergencial_do_Governo"
            name="entry.730457284"
            id="730457284.Auxílio_emergencial_do_Governo"
          />
          <label for="730457284.Auxílio_emergencial_do_Governo"
            >Auxílio emergencial do Governo</label
          >
          <br />
          <br />
          <input
            type="checkbox"
            value="Bolsa-família"
            name="entry.730457284"
            id="730457284.Bolsa-família"
          />
          <label for="730457284.Bolsa-família">Bolsa-família</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="outros"
            name="entry.730457284"
            id="730457284.outros"
          />
          <label for="730457284.outros">Outros</label>
        </div>
        <button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Tipo de doação</p>
        <div class="multipleChoiceContainer">
          <input
            type="checkbox"
            value="Cesta_básica"
            name="entry.1896023146"
            id="1896023146.Cesta_básica"
          />
          <label for="1896023146.Cesta_básica">Cesta básica</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Alimentos"
            name="entry.1896023146"
            id="1896023146.Alimentos"
          />
          <label for="1896023146.Alimentos">Alimentos</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Alimentos_infantis"
            name="entry.1896023146"
            id="1896023146.Alimentos_infantis"
          />
          <label for="1896023146.Alimentos_infantis">Alimentos infantis</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Leite"
            name="entry.1896023146"
            id="1896023146.Leite"
          />
          <label for="1896023146.Leite">Leite</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Verduras"
            name="entry.1896023146"
            id="1896023146.Verduras"
          />
          <label for="1896023146.Verduras">Verduras</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Fraldas"
            name="entry.1896023146"
            id="1896023146.Fraldas"
          />
          <label for="1896023146.Fraldas">Fraldas</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Roupas"
            name="entry.1896023146"
            id="1896023146.Roupas"
          />
          <label for="1896023146.Roupas">Roupas</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Itens_de_limpeza"
            name="entry.1896023146"
            id="1896023146.Itens_de_limpeza"
          />
          <label for="1896023146.Itens_de_limpeza">Itens de limpeza</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Itens_de_higiene"
            name="entry.1896023146"
            id="1896023146.Itens_de_higiene"
          />
          <label for="1896023146.Itens_de_higiene">Itens de higiene</label>
          <br />
          <br />
          <input
            type="checkbox"
            value="Itens_de_proteçao_pessoal"
            name="entry.1896023146"
            id="1896023146.Itens_de_proteçao_pessoal"
          />
          <label for="1896023146.Itens_de_proteçao_pessoal"
            >Itens de proteção</label
          >
        </div>
        <button class="next">Próximo</button>
      </div>
      <div class="question">
        <p class="title">Especificação da doação</p>
        <p class="subtitle">Conte mais sobre suas necessidades</p>
        <textarea
          name="entry.363426765"
          id="363426765"
          placeholder="Digite aqui..."
        ></textarea
        ><br /><button id="send">Finalizar</button>
      </div>
    </div>
    <script>
      let step = 0;
      const build = [
        {
          title: "Nome *",
          type: "text",
          required: true,
          name: "entry.1707728601",
        },
        {
          title: "CPF *",
          type: "text",
          required: true,
          name: "entry.859324267",
        },
        {
          title: "Telefone *",
          type: "text",
          required: true,
          name: "entry.472405798",
        },
        {
          title: "Profissão",
          type: "text",
          required: false,
          name: "entry.1851459686",
        },
        {
          title: "Cidade *",
          type: "text",
          required: true,
          name: "entry.1509069398",
        },
        {
          title: "Bairro *",
          type: "text",
          required: true,
          name: "entry.1231759706",
        },
        {
          title: "Rua *",
          type: "text",
          required: true,
          name: "entry.106456020",
        },
        {
          title: "Numero e complemento *",
          type: "text",
          required: true,
          name: "entry.505288745",
        },
        {
          title: "Ponto de referencia",
          type: "text",
          required: false,
          name: "entry.805271285",
        },
        {
          title: "quantas pessoas moram? *",
          type: "text",
          required: true,
          name: "entry.1238987351",
        },
        {
          title: "Fonte de renda",
          type: "checkbox",
          options: [
            "Salário",
            "Auxílio emergencial do Governo",
            "Bolsa-família",
            "Opção 4",
          ],
          required: false,
          name: "entry.730457284",
        },
        {
          title: "Tipo de doação",
          type: "checkbox",
          options: [
            "Cesta básica",
            "Alimentos",
            "Alimentos infantis",
            "Leite",
            "Verduras",
            "Fraldas",
            "Itens de limpeza",
            "Itens de higiene",
            "Itens de proteçao pessoal",
          ],
          required: false,
          name: "entry.1896023146",
        },
        {
          title: "Especificação da doação",
          type: "textarea",
          required: false,
          name: "entry.363426765",
        },
      ];
      const hasMessage = 1;
      const height = window.document.documentElement.clientHeight;

      function checkFilled() {
        let i = step;
        if (hasMessage && i === 0) {
          return true;
        } else if (hasMessage) {
          i--;
        }
        let name = build[i].name;
        let el = document.getElementsByName(name);

        let hasValue = false;
        let isRequired = false;
        let regex = null;
        let regexMatch = true;
        el.forEach((e) => {
          if (e.getAttribute("data-required") === "true") isRequired = true;
          if (e.getAttribute("data-regex")) {
            regex = new RegExp(e.getAttribute("data-regex"));
            regexMatch = false;
          }
          if (e.value) hasValue = true;
          if (regex && regex.test(e.value)) regexMatch = true;
        });

        return Boolean(regexMatch && (!isRequired || (isRequired && hasValue)));
      }

      function next() {
        const canPass = checkFilled();
        if (!canPass) {
          alert("Você deve responder propriamente para continuar!");
          return false;
        }
        const els = document.querySelectorAll(".question");
        els.forEach((e) => {
          e.style.top = "-" + (step + 1) * 100 + "vh";
        });
        step++;
      }

      function listCheckbox(obj, name, val) {
        console.log(obj, name, val);
        if (!obj[name]) {
          obj[name] = [val];
        } else {
          obj[name].push(val);
        }
        console.log(obj);
        return obj;
      }

      function formatObj() {
        obj = {};
        const e = document.querySelectorAll("input, textarea, select");
        for (let i = 0; i < e.length; i++) {
          let c = e[i],
            n = c.getAttribute("name");
          if (n) {
            if (
              ((c.type === "checkbox" || c.type === "radio") && c.checked) ||
              (c.type !== "checkbox" && c.type !== "radio" && obj[n])
            ) {
              obj = listCheckbox(obj, n, c.value);
            } else if (c.type !== "checkbox" && c.type !== "radio") {
              obj[n] = c.value;
            }
          }
        }
        const linearObj = {};
        Object.keys(obj).forEach((k) => {
          linearObj[k] = String(obj[k]);
        });

        console.log(linearObj);
        return linearObj;
      }

      function checkData(data) {
        Object.keys(data).forEach((entry, i) => {
          if (build[i].required && !data[entry]) {
            highlightRequired(entry);
            throw "Campo obrigatório";
          }
        });
      }

      function highlightRequired(name) {
        document.getElementsByName(name).forEach((e) => {
          e.classList.add("blink");
          setTimeout(e.classList.remove("blink"), 4000);
        });
      }

      async function send() {
        const data = formatObj();
        checkData(data);
        const formData = new FormData();
        for (var key in data) {
          formData.append(key, data[key]);
        }

        enviarForm(
          "1FAIpQLSezrWbn_uGiAL0rQlLnPu6H5oIUzBB2cHgvTbVgwrZm5pMjTA",
          data,
          "/mensagem-fim.html"
        );
        alert("Recebemos o seu formulário e em breve entraremos em contato!");

        document.getElementById("send").disabled = true;
      }

      window.document.querySelectorAll("button.next").forEach((b) => {
        b.addEventListener("click", next, false);
      });

      window.document
        .getElementById("send")
        .addEventListener("click", send, false);

      window.addEventListener("load", function () {
        if (true) {
          document.querySelectorAll("input").forEach((e) =>
            e.addEventListener("keypress", function (e) {
              if (e.key === "Enter") {
                next();
              }
            })
          );

          document.querySelectorAll("input[type='radio']").forEach((e) => {
            e.addEventListener(
              "click",
              () => {
                setTimeout(next, 200);
              },
              false
            );
          });
        }

        const masks = document.querySelectorAll("[data-mask]");

        if (masks.length) {
          let script = "";
          masks.forEach((el) => {
            const id = el.id;
            const mask = el.getAttribute("data-mask");
            console.log(id, mask);
            script += `const Mask_${id} = IMask(document.getElementById("${id}"), {
          mask: [
            {
              mask: "${mask}",
            },
          ],
        });`;
          });
          const scr = document.createElement("script");
          scr.innerHTML = script;
          window.document.body.appendChild(scr);
        }
      });
    </script>
  </body>
</html>
